<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ä»»åŠ¡å®ŒæˆçŠ¶æ€æµ‹è¯•</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; padding: 20px; max-width: 600px; margin: 0 auto; }
    h1 { font-size: 1.2rem; color: #333; }
    .test-section { margin: 20px 0; padding: 15px; background: #f5f5f5; border-radius: 8px; }
    .test-section h2 { font-size: 1rem; margin: 0 0 10px 0; color: #666; }
    button { padding: 10px 20px; margin: 5px; border: none; border-radius: 6px; background: #007AFF; color: white; cursor: pointer; }
    button:hover { background: #0056CC; }
    .log { margin-top: 10px; padding: 10px; background: #fff; border-radius: 4px; font-family: monospace; font-size: 0.85rem; max-height: 300px; overflow-y: auto; }
    .log-entry { margin: 5px 0; padding: 5px; border-left: 3px solid #007AFF; padding-left: 10px; }
    .error { border-left-color: #FF3B30; color: #FF3B30; }
    .success { border-left-color: #34C759; color: #34C759; }
    .info { border-left-color: #FF9500; color: #FF9500; }
  </style>
</head>
<body>
  <h1>ğŸ§ª ä»»åŠ¡å®ŒæˆçŠ¶æ€æµ‹è¯•å·¥å…·</h1>
  
  <div class="test-section">
    <h2>å½“å‰æ—¶é—´ä¿¡æ¯</h2>
    <div id="time-info"></div>
  </div>

  <div class="test-section">
    <h2>API æµ‹è¯•</h2>
    <button onclick="testGetTasks()">è·å–ä»»åŠ¡åˆ—è¡¨</button>
    <button onclick="testCompleteTask()">æµ‹è¯•å®Œæˆä»»åŠ¡</button>
    <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
  </div>

  <div class="test-section">
    <h2>æµ‹è¯•æ—¥å¿—</h2>
    <div id="log" class="log"></div>
  </div>

  <script>
    // è·å– Shanghai æ—¶åŒºçš„ä»Šå¤©æ—¥æœŸï¼ˆä¸æœåŠ¡å™¨ä¸€è‡´ï¼‰
    function getToday() {
      return new Intl.DateTimeFormat('en-CA', { timeZone: 'Asia/Shanghai' }).format(new Date())
    }

    // æ˜¾ç¤ºæ—¶é—´ä¿¡æ¯
    function updateTimeInfo() {
      const now = new Date()
      const today = getToday()
      document.getElementById('time-info').innerHTML = `
        <p>æœ¬åœ°æ—¶é—´: ${now.toLocaleString('zh-CN')}</p>
        <p>Shanghai æ—¥æœŸ (æœåŠ¡å™¨): ${today}</p>
        <p>ISO æ—¶é—´æˆ³: ${now.toISOString()}</p>
      `
    }
    updateTimeInfo()
    setInterval(updateTimeInfo, 1000)

    // æ—¥å¿—åŠŸèƒ½
    function log(message, type = 'info') {
      const logEl = document.getElementById('log')
      const entry = document.createElement('div')
      entry.className = `log-entry ${type}`
      entry.innerHTML = `<strong>[${new Date().toLocaleTimeString('zh-CN')}]</strong> ${message}`
      logEl.insertBefore(entry, logEl.firstChild)
    }

    function clearLog() {
      document.getElementById('log').innerHTML = ''
    }

    // ä» localStorage è·å– session
    function getSession() {
      const stored = localStorage.getItem('auth-storage')
      if (!stored) return null
      try {
        const parsed = JSON.parse(stored)
        return parsed.state?.session
      } catch (e) {
        return null
      }
    }

    // æµ‹è¯•è·å–ä»»åŠ¡
    async function testGetTasks() {
      const session = getSession()
      if (!session) {
        log('æœªæ‰¾åˆ°ç™»å½•ä¼šè¯ï¼Œè¯·å…ˆç™»å½•åº”ç”¨', 'error')
        return
      }

      // ä» localStorage è·å–å½“å‰å­©å­ID
      const stored = localStorage.getItem('app-storage')
      const currentChildId = stored ? JSON.parse(stored)?.state?.currentChildId : null
      
      if (!currentChildId) {
        log('æœªæ‰¾åˆ°å½“å‰å­©å­ID', 'error')
        return
      }

      log(`æ­£åœ¨è·å–å­©å­ ${currentChildId} çš„ä»»åŠ¡...`, 'info')

      try {
        const res = await fetch(`/api/children/${currentChildId}/tasks`, {
          headers: {
            'Authorization': `Bearer ${session.access_token}`,
            'Cache-Control': 'no-cache'
          }
        })
        
        if (!res.ok) {
          throw new Error(`HTTP ${res.status}: ${await res.text()}`)
        }

        const tasks = await res.json()
        const completedCount = tasks.filter(t => t.completedToday).length
        
        log(`âœ… è·å–æˆåŠŸï¼å…± ${tasks.length} ä¸ªä»»åŠ¡ï¼Œå·²å®Œæˆ ${completedCount} ä¸ª`, 'success')
        
        // æ˜¾ç¤ºå‰3ä¸ªä»»åŠ¡çš„è¯¦æƒ…
        tasks.slice(0, 3).forEach(task => {
          log(`ğŸ“‹ ${task.name}: completedToday=${task.completedToday}, lastCompletedDate=${task.lastCompletedDate}`, 'info')
        })
      } catch (err) {
        log(`âŒ é”™è¯¯: ${err.message}`, 'error')
      }
    }

    // æµ‹è¯•å®Œæˆä»»åŠ¡ï¼ˆéœ€è¦ç”¨æˆ·è¾“å…¥ä»»åŠ¡IDï¼‰
    async function testCompleteTask() {
      const taskId = prompt('è¯·è¾“å…¥ä»»åŠ¡ID (taskId):')
      if (!taskId) return

      const session = getSession()
      if (!session) {
        log('æœªæ‰¾åˆ°ç™»å½•ä¼šè¯ï¼Œè¯·å…ˆç™»å½•åº”ç”¨', 'error')
        return
      }

      log(`æ­£åœ¨å®Œæˆä»»åŠ¡ ${taskId}...`, 'info')

      try {
        const res = await fetch(`/api/tasks/${taskId}/complete`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${session.access_token}`,
            'Content-Type': 'application/json'
          }
        })

        const data = await res.json()
        
        if (!res.ok) {
          throw new Error(data.error || `HTTP ${res.status}`)
        }

        log(`âœ… ä»»åŠ¡å®Œæˆï¼`, 'success')
        log(`ğŸ“Š è¿”å›æ•°æ®: completedToday=${data.task.completedToday}, lastCompletedDate=${data.task.lastCompletedDate}`, 'info')
        log(`ğŸ’° è·å¾—ç§¯åˆ†: ${data.earnedPoints}${data.bonusPoints > 0 ? ' (+' + data.bonusPoints + ' å¥–åŠ±)' : ''}`, 'success')
      } catch (err) {
        log(`âŒ é”™è¯¯: ${err.message}`, 'error')
      }
    }

    log('æµ‹è¯•å·¥å…·å·²åŠ è½½ã€‚è¯·å…ˆåœ¨ä¸»åº”ç”¨ç™»å½•ï¼Œç„¶åè¿”å›æ­¤é¡µé¢æµ‹è¯•ã€‚', 'info')
  </script>
</body>
</html>
